{% extends "index.html" %}

{% block title %}마이페이지 | 이화마켓{% endblock %}

{% block styles %}
<link rel="stylesheet" href="css/mypage.css">
<link rel="stylesheet" href="css/product-list.css">
{% endblock %}

{% block section %}
<main class="main-content container">

    <div class="card profile">
        <label for="profile-img-upload" class="my-img-area">
            <div class="my-img" id="my-profile-img"
                {% if user_info.profile_img %}
                style="background-image: url('/{{ user_info.profile_img }}'); background-size: cover; background-position: center;"
                {% endif %}>
            </div>
            <span class="change-photo-text">사진<br>변경</span>
        </label>
        <input type="file" id="profile-img-upload" name="profile-img" accept="image/*" style="display: none;">

        <h3 class="my-name">{{ user_id | default('사용자') }}</h3>
        <p class="seller-info">
            <span class="product-state" id="available">판매 중 {{ available_count }}</span>
            <span class="product-state" id="sold">판매 완료 {{ sold_count }}</span>
        </p>

        <button class="btn btn-green btn-full">개인정보 변경</button>
        <button class="btn btn-white btn-full"><a href="/logout">로그아웃</a></button>
    </div>

    <div class="activity-section">
        <div class="category-filter mypage-tabs">
            <button id="tab-sales" class="btn-pill btn-pill-active" onclick="switchTab('sales')">내 판매 상품</button>
            <button id="tab-purchases" class="btn-pill btn-pill-inactive" onclick="switchTab('purchases')">내 구매
                상품</button>
        </div>
        <div id="list-sales" class="product-grid">
            {% if my_sales|length > 0 %}
            {% for key, item in my_sales %}
            <a href="{{ url_for('product_detail', name=key) }}" style="text-decoration: none; color: inherit;">
                <div class="product-card {{ 'product-card--sold' if item.status == '거래 완료' else '' }}">
                <div class="product-card-image">
                    {% if item.img_path %}
                    <img src="{{ item.img_path }}" alt="{{ item.title }}"
                        style="width:100%; height:100%; object-fit:cover;">
                    {% endif %}
                </div>
                <div class="product-card-content">
                    {% set status_class = 'tag-status-used' %}
                    {% if item.status == "상태 최상" %}
                    {% set status_class = 'tag-status-great' %}
                    {% elif item.status == "약간의 하자" %}
                    {% set status_class = 'tag-status-defect' %}
                    {% endif %}

                    <span class="tag-status {{ status_class }}">
                        {{ item.status | default('상태 없음') }}
                    </span>

                    <h3 class="product-title">{{ item.title }}</h3>
                    <div><span class="tag-info">#{{ item.trade_method }}</span></div>
                    <div class="product-meta-row">
                        <p class="product-price">{{ item.price }}원</p>
                    </div>
                    <div class="manage-buttons" onclick="event.preventDefault(); event.stopPropagation();">
                        <button class="btn-text-small">수정</button> |
                        <button class="btn-text-small">삭제</button>
                    </div>
                </div>
            </div>
            </a>
            {% endfor %}
            {% else %}
            <p style="padding: 20px; grid-column: 1 / -1;">판매 내역이 없습니다.</p>
            {% endif %}
        </div>

        <div id="list-purchases" class="product-grid" style="display: none;">
            {% if my_purchases|length > 0 %}
            {% for key, item in my_purchases %}
            <a href="{{ url_for('product_detail', name=key) }}" style="text-decoration: none; color: inherit;">
            <div class="product-card">
                <div class="product-card-image">
                    {% if item.img_path %}
                    <img src="{{ item.img_path }}" alt="{{ item.title }}"
                        style="width:100%; height:100%; object-fit:cover;">
                    {% endif %}
                </div>
                <div class="product-card-content">
                    {% set status_class = 'tag-status-used' %}
                    {% if item.status == "상태 최상" %}
                    {% set status_class = 'tag-status-great' %}
                    {% elif item.status == "약간의 하자" %}
                    {% set status_class = 'tag-status-defect' %}
                    {% endif %}

                    <span class="tag-status {{ status_class }}">
                        {{ item.status }}
                    </span>
                    <h3 class="product-title">{{ item.title }}</h3>
                    <div><span class="tag-info">#{{ item.author }}님에게 구매</span></div>
                    <div class="product-meta-row">
                        <p class="product-price">{{ item.price }}원</p>
                    </div>
                    <div class="manage-buttons" onclick="event.preventDefault(); event.stopPropagation();">
                        <a href="{{ url_for('review_write') }}?item_name={{ item.title }}" class="btn-text-small btn-green-text">리뷰 작성</a>
                    </div>
                </div>
            </div>
            </a>
            {% endfor %}
            {% else %}
            <p style="padding: 20px; grid-column: 1 / -1;">구매 내역이 없습니다.</p>
            {% endif %}
        </div>

        <script>
            function switchTab(tabName) {
                const salesList = document.getElementById('list-sales');
                const purchasesList = document.getElementById('list-purchases');
                const salesBtn = document.getElementById('tab-sales');
                const purchasesBtn = document.getElementById('tab-purchases');

                if (tabName === 'sales') {
                    salesList.style.display = 'grid';
                    purchasesList.style.display = 'none';

                    salesBtn.classList.add('btn-pill-active');
                    salesBtn.classList.remove('btn-pill-inactive');
                    purchasesBtn.classList.add('btn-pill-inactive');
                    purchasesBtn.classList.remove('btn-pill-active');
                } else {
                    salesList.style.display = 'none';
                    purchasesList.style.display = 'grid';

                    purchasesBtn.classList.add('btn-pill-active');
                    purchasesBtn.classList.remove('btn-pill-inactive');
                    salesBtn.classList.add('btn-pill-inactive');
                    salesBtn.classList.remove('btn-pill-active');
                }
            }

            async function uploadProfileImage(input) {
                if (input.files && input.files[0]) {
                    const formData = new FormData();
                    formData.append('profile_image', input.files[0]);

                    try {
                        const response = await fetch('/api/upload_profile_img', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();

                        if (result.success) {
                            // 업로드 성공 시 즉시 이미지 변경 반영
                            const imgDiv = document.getElementById('my-profile-img');
                            // 캐시 방지를 위해 랜덤 쿼리스트링 추가
                            imgDiv.style.backgroundImage = `url('/${result.image_path}?t=${new Date().getTime()}')`;
                            imgDiv.style.backgroundSize = 'cover';
                            imgDiv.style.backgroundPosition = 'center';
                            alert("프로필 사진이 변경되었습니다.");
                        } else {
                            alert(result.message || "사진 업로드 실패");
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert("서버 통신 오류가 발생했습니다.");
                    }
                }
            }

            // 파일 input에 change 이벤트 리스너 추가
            document.getElementById('profile-img-upload').addEventListener('change', function() {
                uploadProfileImage(this);
            });
        </script>
    </div>
</main>
{% endblock %}