{% extends "index.html" %}

{% block title %}찜 | 이화마켓{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="css/product-wishlist.css">
{% endblock %}

{% block section %}
  <main class="main-content">
    <div class="card wishlist-card">
      <h2 class="wishlist-title">내가 찜한 상품</h2>
      <p class="wishlist-sub">하트를 누른 상품만 모아봤어요.</p>

      <!-- Empty state -->
      <section id="emptyState" class="wishlist-empty {% if total > 0 %}hidden{% endif %}">
        <p>아직 찜한 상품이 없어요.</p>
        <a href="/product-list.html" class="btn btn-green">상품 보러가기</a>
      </section>

      <!-- Card grid -->
      <section id="grid" class="wishlist-grid {% if total == 0 %}hidden{% endif %}">
        {% if total > 0 %}
          {% for key, item in datas %}
            <article class="product-card">
              <!-- Click anywhere on this thumb to go to detail page -->
              <a class="thumb" href="/product-detail/{{ key }}">
                {% if item.img_path %}
                  <img src="/{{ item.img_path }}" alt="{{ item.title }}">
                {% endif %}
                <span class="badge">{{ item.category or '전체' }}</span>
              </a>
              <div class="meta">
                <h3 class="title">{{ item.title }}</h3>
                <div class="row">
                  <span class="price">{{ item.price | int }}원</span>
                  <!-- Heart button to un-wish -->
                  <button class="heart filled"
                          data-item-name="{{ key }}"
                          aria-label="찜 해제">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <use href="#icon-heart-filled"></use>
                    </svg>
                  </button>
                </div>
              </div>
            </article>
          {% endfor %}
        {% endif %}
      </section>

      <!-- Pagination -->
      <div id="wishlistPaginationWrapper" class="pagination" aria-label="페이지네이션">
        {% if page_count > 1 %}
          <ul id="wishlist-pagination" class="pagination-list">
            {% for p in range(1, page_count + 1) %}
              <li>
                <a href="/product-wishlist.html?page={{ p }}"
                   class="{% if p == page %}active{% endif %}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const grid = document.getElementById("grid");
  const empty = document.getElementById("emptyState");

  if (!grid) return;

  grid.addEventListener("click", async function (e) {
    const btn = e.target.closest(".heart");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const itemName = btn.dataset.itemName;
    if (!itemName) return;

    try {
      const res = await fetch("/api/toggle_like", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ item_name: itemName })
      });

      const data = await res.json();

      if (res.ok && data.success) {

        // If unliked → remove card
        if (!data.liked) {
          const card = btn.closest(".product-card");
          if (card) {
            card.remove();
          }

          // If no items left → show empty message
          if (grid.children.length === 0 && empty) {
            empty.classList.remove("hidden");
            grid.classList.add("hidden");
          }
        }

        alert(data.message || "찜 상태가 변경되었습니다.");

      } else {
        alert(data.message || "찜 처리 중 오류가 발생했습니다.");
      }

    } catch (err) {
      console.error("wishlist toggle_like error:", err);
      alert("서버 통신 중 오류가 발생했습니다.");
    }
  });

});
</script>
{% endblock %}
