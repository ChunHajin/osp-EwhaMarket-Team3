{% extends "index.html" %}

{% block title %}상품 상세 | 이화마켓{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="/css/product-detail.css">
{% endblock %}

{% block section %}
  <main class="main-content">
    <div class="card">
      <div class="detail-grid">
        <div>
          <div class="product-image-main">
            {% if data.img_path %}
              <img src="/{{ data.img_path }}" alt="{{ data.title }}" style="width:100%; height:100%; object-fit:cover;">
            {% endif %}
          </div>
          <div class="product-image-gallery">
            <div class="product-image-thumb product-image-thumb-active"></div>
            <div class="product-image-thumb"></div>
          </div>
        </div>

        <div>
          <div class="seller-info">
            <div class="seller-avatar"></div>
            <div>
              <p class="seller-name">{{ data.author | default('판매자') }}</p>
              <p class="seller-location">서울 서대문구 대신동</p> </div>
          </div>

          <h1 class="product-title">{{ data.title | default(name) }}</h1>
          <p class="product-meta">{{ data.category | default('전체') }} ・ 3시간 전</p> <p class="product-price">{{ data.price | default(0) | int }}원</p>

          <div class="product-description-container">
            <h2 class="product-description-title">상품설명</h2>
            <p class="product-description-text">{{ data.desc | default('설명 없음') }}</p>
          </div>

          <div class="product-info-grid">
            <div><span class="product-info-label">상품 상태:</span> {{ data.status | default('N/A') }}</div>
            <div><span class="product-info-label">거래 방식:</span> {{ data.region }} {{ data.trade_method | default('N/A') }}</div>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-green btn-full btn-large" onclick="requestPurchase('{{ name }}')">구매하기</button>
            <button class="btn-icon-like">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <use href="#icon-heart"></use>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
async function requestPurchase(itemName) {
    if (!confirm("정말 구매하시겠습니까?")) return;

    try {
        const response = await fetch('/api/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ item_name: itemName })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert("구매가 완료되었습니다! 마이페이지로 이동합니다.");
            window.location.href = "/mypage.html";
        } else {
            alert(result.message || "구매 실패");
            if (response.status === 401) {
                window.location.href = "/login.html";
            }
        }
    } catch (error) {
        console.error("Error:", error);
        alert("서버 통신 중 오류가 발생했습니다.");
    }
}
</script>
{% endblock %}