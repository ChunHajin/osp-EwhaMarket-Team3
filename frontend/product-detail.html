{% extends "index.html" %}

{% block title %}상품 상세 | 이화마켓{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="/css/product-detail.css">
{% endblock %}

{% block section %}
  <main class="main-content">
    <div class="card">
      <div class="detail-grid">
        <div>
          <div class="product-image-main">
            {% if data.img_path %}
              <img src="/{{ data.img_path }}" alt="{{ data.title }}" style="width:100%; height:100%; object-fit:cover;">
            {% endif %}
          </div>
        </div>

        <div>
          <div class="seller-info">
            <div class="seller-avatar" 
                 {% if seller_info and seller_info.profile_img %}
                 style="background-image: url('/{{ seller_info.profile_img }}'); background-size: cover; background-position: center;"
                 {% endif %}></div>
            <div>
              <p class="seller-name">{{ data.author | default('판매자') }}</p>
              <p class="seller-location">서울 서대문구 대신동</p> </div>
          </div>

          <h1 class="product-title">{{ data.title | default(name) }}</h1>
          <p class="product-meta">{{ data.category | default('전체') }} ・ {{ format_time_ago(data.created_at) if data.created_at }}</p> <p class="product-price">{{ data.price | default(0) | int }}원</p>

          <div class="product-description-container">
            <h2 class="product-description-title">상품설명</h2>
            <p class="product-description-text">{{ data.desc | default('설명 없음') | nl2br }}</p>
          </div>

          <div class="product-info-grid">
            <div><span class="product-info-label">상품 상태:</span> {{ data.status | default('N/A') }}</div>
            <div><span class="product-info-label">거래 방식:</span> {{ data.region }} {{ data.trade_method | default('N/A') }}</div>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-green btn-full btn-large" onclick="requestPurchase('{{ name }}')">구매하기</button>
        
            </button>
            <button
              type="button"
              class="btn-icon-like {% if liked %}liked{% endif %}"
              id="likeButton"
              data-item-name="{{ name }}"
              aria-pressed="{{ 'true' if liked else 'false' }}"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                {% if liked is true %}
                  <use href="#icon-heart-filled"></use>
                {% else %}
                  <use href="#icon-heart"></use>
                {% endif %}
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
async function requestPurchase(itemName) {
    if (!confirm("정말 구매하시겠습니까?")) return;

    try {
        const response = await fetch('/api/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ item_name: itemName })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert("구매가 완료되었습니다! 마이페이지로 이동합니다.");
            window.location.href = "/mypage.html";
        } else {
            alert(result.message || "구매 실패");
            if (response.status === 401) {
                window.location.href = "/login.html";
            }
        }
    } catch (error) {
        console.error("Error:", error);
        alert("서버 통신 중 오류가 발생했습니다.");
    }
}
/* ------------------- 여기부터 좋아요 기능 추가 ------------------- */

const likeButton = document.getElementById('likeButton');
const USER_ID = "{{ user_id or '' }}";  // 로그인 정보 (inject_user 사용)

function updateHeart(liked) {
  if (!likeButton) return;
  const useEl = likeButton.querySelector('use');
  if (liked) {
    likeButton.classList.add("liked");
  if (useEl) useEl.setAttribute('href', '#icon-heart-filled');
  } else {
    likeButton.classList.remove("liked");
  if (useEl) useEl.setAttribute('href', '#icon-heart');
}
}

async function fetchLikeStatus(itemName) {
    try {
        const res = await fetch(`/api/like_status?item_name=${encodeURIComponent(itemName)}`);
        const data = await res.json();
        if (data.success) {
            updateHeart(data.liked);
        }
    } catch (e) {
        console.error("like_status error:", e);
    }
}

async function toggleLike(itemName) {
    if (!USER_ID) {
        alert("로그인 후 이용 가능합니다.");
        window.location.href = "/login.html";
        return;
    }

    try {
        const res = await fetch("/api/toggle_like", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ item_name: itemName })
        });

        const data = await res.json();

        if (res.ok && data.success) {
            updateHeart(data.liked);
            alert(data.message);  
        } else {
            alert(data.message || "좋아요 처리 중 오류가 발생했습니다.");
        }
    } catch (e) {
        console.error("toggle_like error:", e);
        alert("서버 통신 중 오류가 발생했습니다.");
    }
}
document.addEventListener("DOMContentLoaded", () => {
  if (!likeButton) return;

  const itemName = likeButton.dataset.itemName;

  // 누르면 좋아요 토글
  likeButton.addEventListener("click", () => {
    if (!itemName) return;
    toggleLike(itemName);
  });
});

</script>
{% endblock %}